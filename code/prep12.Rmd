---
title: "EPIC Pipeline"
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  parameterfile: ""
output:
  pdf_document:
    toc: true
    toc_depth: 2
    keep_tex: true
---

```{r setup, include=FALSE, echo = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
start.Time = Sys.time()
formatted.time = format(Sys.time(), "%Y-%m-%d-%Hh%Mm")
source(params$parameterfile)
source("Part0.R")
```
This is a pipeline for preprocessing EPIC-Methylation data using R. 

```{r child = 'prepPart1.Rmd'}
```
```{r child = 'prepPart2.Rmd'}
```

## Output

```{r}
analysisfilename = paste0("analysis_ready_",projectname,"_",formatted.time,".Rdata")
qcfilename=paste0("QC_data_",projectname,"_",formatted.time,".Rdata")

controlfilename <- paste0("controlprobes_",qcfilename)
rawtypesfilename <- paste0("raw_intensitites_",qcfilename)
detpfilename <- paste0("detp_intensities",qcfilename)
analysisdata_filename <- paste0("analysisdata_",qcfilename)

```

1. The following data is included in the Rdata-files `r controlfilename`:
\begin{description}
	\item[ctrl.all, ctrl.complete.Red.all, ctrl.complete.Green.all, control.info] control probe data
	\item[ctrlprobes.scores] rotated control probe intensities into the coordinates given by principal component analysis
\end{description}

2. The following data is included in the Rdata-files `r rawtypesfilename`:
\begin{description}
	\item[TypeII.Red.All etc] list the corresponding intensity values for TypeI (M&U) and Type II, each Green and Red
\end{description}

3. The following data is included in the Rdata-files `r detpfilename`:
\begin{description}
	\item[dp.all] detection p-values of unfiltered idat data
	\item[TypeII.Red.All.d etc] list the corresponding intensity values where detection p-values smaller than threshold $`r detPthreshold`$ are set to missing (NA).
\end{description}

4. The following data is included in the Rdata-files `r analysisdata_filename`:
\begin{description}
	\item[sample.call] the sample call rates
	\item[marker.call] the marker call rates
	\item[beta.raw] the $\beta$ values calculated for autosomal probes with detection p value filter only
	\item[beta.raw.sex] the $\beta$ values calculated for sex chromosome probes with detection p value filter only
	\item[est.wbc.minfi] the white-blood-cell estimations by minfi method based on RGsets (only if estimateCellCounts is set to TRUE in the parameterfile)
\end{description}



```{r}
	save(ctrl.all, ctrlprobes.scores,ctrl.complete.Red.all, ctrl.complete.Green.all, control.info, file=paste0(outputdir,'/',controlfilename))
	save(TypeII.Red.All ,TypeII.Green.All , TypeI.Red.M.All ,TypeI.Red.U.All , TypeI.Green.M.All ,TypeI.Green.U.All, file=paste0(outputdir,'/',rawtypesfilename))
	save(TypeII.Red.All.d ,TypeII.Green.All.d , TypeI.Red.M.All.d ,TypeI.Red.U.All.d , TypeI.Green.M.All.d , TypeI.Green.U.All.d, dp.all,  file=paste0(outputdir,'/',detpfilename))


if(exists("est.wbc.minfi")){
	save(sample.call, marker.call, beta.raw, beta.raw.sex, est.wbc.minfi, file=paste0(outputdir,'/',analysisdata_filename))
} else {
	save(sample.call, marker.call, beta.raw, beta.raw.sex, file=paste0(outputdir,'/',analysisdata_filename))
}
```

```{r}
if(InterQuartileRangeCalculation == TRUE){
	cat("The inter quartile calculations cannot be done without quantile normalisation.\n")
	cat("Please change the parameter QuantileNormalize in the parameterfile.")
}
```

## Remarks for further processing

For quantile normalization, please

  * If not already done, prepare a file *samplesfilefinal* with the same structure as *samplesfile* where outlier are removed. 

  * If needed, readjust the parameters. 

The file *samples.filtered.csv* provides information about the detected outlier and the reason of detection.  
Remember to also switch *QuantileNormalisation=TRUE* in the *parameterfile* to prepare the data for analysis. 
If you want to have the Quality Control without the filtered samples in the second run, please exclude them from *samplesfile* as well and not only from *samplesfilefinal*. In that case, you can just name the same file for both parameters. 




```{r child = 'MemoryMethodsCredits.Rmd'}
```
